<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UMS - Students</title>


  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <!-- Bootstrap Table plugin -->
  <link href="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.css" rel="stylesheet">

  <!-- Sticky Header extension to the plugin -->
  <link href="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/sticky-header/bootstrap-table-sticky-header.css"
    rel="stylesheet">

  <!-- Filter control extension to the plugin -->
  <!-- <link rel="stylesheet" type="text/css"
    href="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.css"> -->

  <!-- Fixed columns extension to the plugin -->
  <!-- <link
    href="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/fixed-columns/bootstrap-table-fixed-columns.min.css"
    rel="stylesheet"> -->

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <link href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" rel="stylesheet"
    integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

  <!-- Local stylesheets -->
  <link rel="stylesheet" href="css/style.css">

</head>

<body>

  <div id="modals-placeholder">
  </div>

  <div id="toast-placeholder">
  </div>

  <nav id="nav-placeholder">
  </nav>

  <div id="loading-placeholder">
  </div>

  <!-- <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html">UMS</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" href="lookup_students.html">Students</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="lookup_professors.html">Professors</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="lookup_courses.html">Courses</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="lookup_degrees.html">Degrees</a>
          </li>
        </ul>
        <form class="d-flex">
          <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
          <button class="btn btn-outline-secondary" type="submit">Search</button>
          <button class="btn btn-outline-dark ms-3" type="button" onclick="location.href='welcome.html'">
            <i class="bi bi-power"></i>
          </button>
        </form>
      </div>
    </div>
  </nav> -->


  <div class="container">

    <h3 class="h3 mt-4">
      Students list<br />
      <small class="h4 text-muted">List of all the students enrolled at the university</small>
    </h3>

    <div class="my-3">
      <table id="table"></table>
    </div>

    <h4 class="h4 mt-5">Actions</h4>
    <div id="buttons-placeholder">
    </div>

  </div>




  <!-- JQuery script -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <!-- Bootstrap 5 script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>

  <!-- Bootstrap Table plugin script -->
  <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.js"></script>

  <!-- Sticky Header extension script -->
  <script
    src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js"></script>

  <!-- Filter control extension script -->
  <!-- <script
    src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script> 
  <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/filter-control/utils.min.js"></script>-->

  <!-- Fixed columns extension script -->
  <!-- <script
    src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/fixed-columns/bootstrap-table-fixed-columns.min.js"></script> -->

  <!-- Print extension script -->
  <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/print/bootstrap-table-print.min.js"></script>

  <!-- Export extension scripts -->
  <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/tableExport.min.js"></script>
  <script type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/html2canvas/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF/jspdf.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF-AutoTable/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/export/bootstrap-table-export.min.js"></script>


  <!-- Key events extension scripts -->
  <script
    src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/key-events/bootstrap-table-key-events.min.js"></script>

  <!-- Addrbar extension script -->
  <!-- <script
    src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/addrbar/bootstrap-table-addrbar.min.js"></script> -->


  <!-- Local scripts -->
  <script type="text/javascript" src="js/tableScript.js"></script>
  <script type="text/javascript" src="js/buttonsScript.js"></script>
  <script type="text/javascript" src="js/modalsScript.js"></script>
  <script type="text/javascript" src="js/toastScript.js" defer></script>
  <script type="text/javascript" src="js/navbarScript.js"></script>
  <script type="text/javascript" src="js/loadingScript.js"></script>
  <script type="text/javascript" src="js/formattersScript.js"></script>





  <script>




    $(document).ready(function () {

      extraButtons.remove();
      examsButtons.remove();
      studentsButtons.remove();
      coursesButtons.remove();
      TBDButtons.remove();

      newEntryStudyButton.remove();
      editEntryStudyButton.remove();

      editEntryPersonButton.disabled = true;

      buttons.classList.remove("invisible");

      //newEntryPersonButton.addEventListener('click', newEntryStudentFunction);
      //promoteButton.addEventListener('click', promoteFunction);
      //deleteButton.addEventListener('click', deleteEntryStudentFunction);

      newEntryPersonButton.addEventListener('click', getGenders)


    });










    // POST - JSON

    


    // PUT - ...FORM...

    async function promoteFunction() {
      let windowScrollPosition = $(window).scrollTop()

      var history = JSON.parse(localStorage["history"]);

      let currentRows = $table.bootstrapTable('getData');
      var editedRows = [];

      for (let index = 0; index < currentRows.length; index++) {

        const response = await fetch('http://localhost:8080/students/update/' + currentRows[index].id, {
          method: 'put',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
          },
          body: new URLSearchParams({
            "level": currentRows[index].level + 1
          })
        }).then(response => response.json())
          .then(data => {
            editedRows.push(data.data.student);


            // Last loop to only do it once
            if (index == currentRows.length - 1) {

              // Rows edited
              for (let i = 0; i < editedRows.length; i++) {

                // History tables
                for (let j = 0; j < history.length; j++) {

                  // History rows
                  for (let k = 0; k < history[j].length; k++) {

                    if (editedRows[i].id == history[j][k].id) {
                      // Updating the item of the history
                      history[j].splice(k, 1, editedRows[i]);
                      break;
                    }

                  }
                }
              }

              $table.bootstrapTable('load', editedRows)

            }

            localStorage["history"] = JSON.stringify(history);
            $(window).scrollTop(windowScrollPosition)
          });
      }
    };


    // DELETE

    async function deleteEntryStudentFunction() {
      let windowScrollPosition = $(window).scrollTop()

      var history = JSON.parse(localStorage["history"]);
      console.log(history)

      // No need to get the reply
      let removedRows = $table.bootstrapTable('getData');

      for (let index = 0; index < removedRows.length; index++) {

        let idOfRowToRemove = removedRows[index].id;

        const response = await fetch('http://localhost:8080/students/delete/' + idOfRowToRemove,
          {
            method: 'delete',
          }
        );


        // Last loop to only do it once
        if (index == removedRows.length - 1) {

          // Rows edited
          for (let i = 0; i < removedRows.length; i++) {

            // History tables
            for (let j = 0; j < history.length; j++) {

              // History rows
              for (let k = 0; k < history[j].length; k++) {

                if (removedRows[i].id == history[j][k].id) {
                  // Updating the item of the history
                  history[j].splice(k, 1);
                  break;
                }

              }
            }
          }

          $table.bootstrapTable('load', [])
        }
      }

      localStorage["history"] = JSON.stringify(history);
      $(window).scrollTop(windowScrollPosition)
    };




    // Shared navbar
    /* $(function () {
      $("#nav-placeholder").load("navbar.html");
    }); */

    /* $('#nav-placeholder').load('navbar.html', function () {
      $(this).children(':first').unwrap();

      console.log(this)
    }); */


    /* var links = linksContainer.getElementsByClassName("nav-link");
    console.log(links.length)

    for (let i = 0; i < links.length; i++) {
      console.log("xxx")
      console.log(this)

      console.log(links[i].getAttribute('href'))

      if (links[i].getAttribute('href') == "lookup_students.html") {
        console.log(i)
      }

      //links[i].addEventListener('click', function () {

      //var current = document.getElementsByClassName("")
      //});

    } */



    // DOM elements
    const $table = $('#table')


    // Columns
    var modelColumns =
      [
        {
          field: 'id',
          title: 'ID',
          visible: false,
          switchable: false,
          filterControl: 'input'
        }, {
          field: 'code',
          title: 'Uni-ID&trade;',
          switchable: false,
          filterControl: 'input'
        }, {
          field: 'lastName',
          title: 'Last name',
          filterControl: 'input',
          class: 'text-nowrap',
        }, {
          field: 'firstName',
          title: 'First name',
          filterControl: 'input',
          class: 'text-nowrap'
        }, {
          field: 'gender',
          title: 'Gender',
          filterControl: 'select',
          class: 'text-nowrap'
        }, {
          field: 'level',
          title: 'Level',
          filterControl: 'select'
        }, {
          field: 'majorDegree',
          title: 'Major degree',
          filterControl: 'select'
        }, {
          field: 'minorDegree',
          title: 'Minor degree',
          filterControl: 'select'
        }, {
          field: 'courses',
          title: 'Enrolled in courses',
          visible: false,
          filterControl: 'input'
        }, {
          field: 'birthdate',
          title: 'Birthdate',
          filterControl: 'input',
          class: 'text-nowrap'
        }, {
          field: 'email',
          title: 'E-mail',
          filterControl: 'input',
          class: 'text-nowrap'
        }, {
          field: 'phone',
          title: 'Phone',
          filterControl: 'input'
        }, {
          field: 'totalTuition',
          title: 'Tuition',
          filterControl: 'input'
        }, {
          field: 'balance',
          title: 'Balance',
          filterControl: 'input'
        }, {
          field: 'credits',
          title: 'Credits',
          filterControl: 'select'
        }, {
          field: 'diploma',
          title: 'Last diploma',
          filterControl: 'select',
          class: 'text-nowrap'
        }, {
          field: 'warnings',
          title: '<i class="bi bi-exclamation-triangle-fill"></i>',
          filterControl: 'select'
        }
      ]


    // Table init
    $.ajax("http://localhost:8080/students/list", {
      success: function (response) {
        // Array from JSON Objects
        var sourceData = response.data.students;
        buildTable($table, sourceData, modelColumns, 0);

      }, complete: function () {
        console.log("complete multiple");
      }
    })






    /* var url = "http://localhost:8080/students/list";
    buildTable($table, url, modelColumns, history, undoChain, lastDoAction, 0);
    $table.bootstrapTable('refreshOptions',
      {
        responseHandler: function (res) { return res.data.students }
      }) */

      //console.log( $table.bootstrapTable('getData') )
    //history.push($table.bootstrapTable('getData'));


  </script>

</body>

</html>